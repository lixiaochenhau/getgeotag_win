name: Build Windows Exe

on: [push]

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'
        
    - name: Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pyinstaller
        
    - name: Download and Prepare ExifTool
      # 下载、解压并递归查找所需文件，移动至构建根目录
      run: |
        # 下载压缩包
        Invoke-WebRequest -Uri "https://github.com/OliverBetz/exiftool-windows/releases/download/12.87/exiftool-12.87_64.zip" -OutFile "exiftool.zip"
        
        # 解压至临时目录
        Expand-Archive -Path "exiftool.zip" -DestinationPath "temp_extract"
        
        # 递归查找可执行文件和依赖文件夹路径
        $exePath = Get-ChildItem -Path "temp_extract" -Filter "exiftool(-k).exe" -Recurse | Select-Object -First 1
        $libPath = Get-ChildItem -Path "temp_extract" -Filter "exiftool_files" -Directory -Recurse | Select-Object -First 1
        
        # 校验文件是否存在
        if (-not $exePath) { Write-Error "ExifTool executable not found"; exit 1 }
        if (-not $libPath) { Write-Error "ExifTool library folder not found"; exit 1 }
        
        # 移动并重命名至工作区根目录
        Move-Item -Path $exePath.FullName -Destination ".\exiftool.exe" -Force
        Move-Item -Path $libPath.FullName -Destination ".\exiftool_files" -Force
        
        # 列出文件以确认
        ls
        
    - name: Build with PyInstaller
      # 执行打包，包含主程序及依赖资源
      run: |
        pyinstaller -n "Getgeotag" -w --onedir --noupx --add-data "exiftool.exe;." --add-data "exiftool_files;exiftool_files" getgeotag.py
        
    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: Getgeotag-Windows
        path: dist/Getgeotag/
