name: Build Windows Exe

on: [push]

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'
        
    - name: Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pyinstaller
        
    - name: Download and Organize (via Python)
      # 使用 Python 脚本处理文件移动，这是最稳健的方法，避开 Shell 语法差异
      run: |
        # 1. 下载
        curl -L -o exiftool.zip https://github.com/OliverBetz/exiftool-windows/releases/download/13.10/exiftool-13.10_64.zip
        
        # 2. 解压
        7z x exiftool.zip -otemp_extract
        
        # 3. 使用 Python 脚本查找并移动文件
        python -c "
        import os
        import shutil
        
        found_exe = False
        found_dir = False
        
        # 遍历临时文件夹查找目标
        for root, dirs, files in os.walk('temp_extract'):
            # 找 exe
            if 'exiftool(-k).exe' in files:
                src = os.path.join(root, 'exiftool(-k).exe')
                dst = 'exiftool.exe'
                print(f'Found exe at: {src}, moving to {dst}')
                if os.path.exists(dst): os.remove(dst)
                shutil.move(src, dst)
                found_exe = True
            
            # 找依赖文件夹
            if 'exiftool_files' in dirs:
                src = os.path.join(root, 'exiftool_files')
                dst = 'exiftool_files'
                print(f'Found dir at: {src}, moving to {dst}')
                if os.path.exists(dst): shutil.rmtree(dst)
                shutil.move(src, dst)
                found_dir = True
        
        if not found_exe:
            print('Error: Exiftool exe not found!')
            exit(1)
        if not found_dir:
            print('Error: Exiftool_files dir not found!')
            exit(1)
        "
        
        # 4. 验证
        dir
        
    - name: Build with PyInstaller
      # 此时 exiftool.exe 和 exiftool_files 都在根目录，直接打包
      run: |
        pyinstaller -n "Getgeotag" -w --onedir --noupx --add-data "exiftool.exe;." --add-data "exiftool_files;exiftool_files" getgeotag.py
        
    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: Getgeotag-Windows
        path: dist/Getgeotag/
