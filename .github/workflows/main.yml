name: Build GetGeoTag Windows

on:
  push:
    branches: [ "main", "master" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest

    steps:
    # 1. 拉取代码
    - name: Checkout Code
      uses: actions/checkout@v4

    # 2. 设置 Python 环境
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        architecture: 'x64'

    # 3. 安装 PyInstaller
    # 您的脚本只使用了标准库(os, sys, tkinter等)，不需要安装 requirements.txt
    - name: Install PyInstaller
      run: |
        python -m pip install --upgrade pip
        pip install pyinstaller

    # 4. 验证 ExifTool 是否存在 (安全检查)
    - name: Verify ExifTool
      run: |
        if (Test-Path "exiftool.exe") {
            Write-Host "ExifTool found in root directory."
        } else {
            Write-Error "ExifTool.exe not found! Please upload it to the repository root."
            exit 1
        }

    # 5. 执行打包
    # 参数解释：
    # --add-data "exiftool.exe;." : 将 exe 放入包的根目录，配合您代码中的 sys._MEIPASS 读取
    # --hidden-import "tkinter" : 显式确保 GUI 库被打包
    - name: Build with PyInstaller
      run: |
        pyinstaller --clean --noconfirm --onefile --windowed --add-data "exiftool.exe;." --hidden-import "tkinter" --name "GetGeoTag" getgeotag.py

    # 6. 上传生成的软件
    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: GetGeoTag-Software
        path: dist/GetGeoTag.exe
